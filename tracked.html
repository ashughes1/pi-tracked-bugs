<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="refresh" content="3600">
<!-- This Source Code Form is subject to the terms of the Mozilla Public
   - License, v. 2.0. If a copy of the MPL was not distributed with this
   - file, You can obtain one at http://mozilla.org/MPL/2.0/. -->
<HTML>
<HEAD>
	<title>Firefox Tracked Bugs</title>
	<script type="text/javascript">function importScript(dep, func){
      if (func !== undefined) func();
    }</script>
	<script type="text/javascript" src="modevlib/Settings.js"></script>
	<script type="text/javascript" src="modevlib/rest/BugzillaClient.js"></script>
	<link type="text/css" rel="stylesheet" href="js/blockers.css"/>
	<script type="text/javascript" src="modevlib/util/aUtil.js"></script>
	<script type="text/javascript" src="modevlib/util/aString.js"></script>
	<script type="text/javascript" src="js/owners.js"></script>
	<script type="text/javascript" src="modevlib/collections/aMatrix.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.aggregate.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.column.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.cube.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.analytic.js"></script>
	<script type="text/javascript" src="modevlib/gui/Filter.js"></script>
	<script type="text/javascript" src="modevlib/gui/ComponentFilter.js"></script>
	<script type="text/javascript" src="modevlib/gui/PartitionFilter.js"></script>
	<script type="text/javascript" src="modevlib/qb/aCompiler.js"></script>
	<script type="text/javascript" src="modevlib/collections/aArray.js"></script>
	<script type="text/javascript" src="modevlib/util/aParse.js"></script>
	<script type="text/javascript" src="modevlib/collections/aRelation.js"></script>
	<script type="text/javascript" src="modevlib/math/aMath.js"></script>

	<script type="text/javascript" src="modevlib/util/CNV.js"></script>
	<script type="text/javascript" src="modevlib/charts/aColor.js"></script>

	<script type="text/javascript" src="modevlib/util/aTemplate.js"></script>
	<script type="text/javascript" src="lib/jquery.js"></script>
	<script type="text/javascript" src="modevlib/util/aDate.js"></script>
	<script type="text/javascript" src="modevlib/collections/aQueue.js"></script>
	<script type="text/javascript" src="modevlib/collections/aSet.js"></script>
	<script type="text/javascript" src="modevlib/debug/aException.js"></script>
	<script type="text/javascript" src="lib/jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
	<script type="text/javascript" src="lib/jquery.numberformatter.js"></script>
	<script type="text/javascript" src="lib/jstree/jquery.jstree.js"></script>
	<script type="text/javascript" src="modevlib/qb/Qb.domain.js"></script>
	<script type="text/javascript" src="modevlib/util/aDuration.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-ui/css/start/jquery-ui-1.10.2.custom.css">
	<script type="text/javascript" src="modevlib/aFormat.js"></script>
	<script type="text/javascript" src="modevlib/gui/TeamFilter.js"></script>
	<script type="text/javascript" src="lib/jquery.ba-bbq/jquery.ba-bbq.js"></script>
	<script type="text/javascript" src="modevlib/debug/aLog.js"></script>
	<script type="text/javascript" src="modevlib/threads/thread.js"></script>
	<script type="text/javascript" src="modevlib/gui/ProgramFilter.js"></script>
	<script type="text/javascript" src="modevlib/util/aTimer.js"></script>

	<script type="text/javascript" src="modevlib/rest/Rest.js"></script>
	<script type="text/javascript" src="modevlib/aLibrary.js"></script>

	<script type="text/javascript" src="modevlib/rest/ElasticSearch.js"></script>
	<script type="text/javascript" src="modevlib/Bugzilla.js"></script>
	<script type="text/javascript" src="modevlib/math/Stats.js"></script>
	<script type="text/javascript" src="modevlib/qb/MVEL.js"></script>
	<link type="text/css" rel="stylesheet" href="lib/jquery-linedtextarea/jquery-linedtextarea.css">
	<script type="text/javascript" src="modevlib/qb/Qb.js"></script>
	<script type="text/javascript" src="lib/jquery-linedtextarea/jquery-linedtextarea.js"></script>
	<script type="text/javascript" src="modevlib/qb/ESQuery.js"></script>
	<script type="text/javascript" src="modevlib/Dimension.js"></script>
	<script type="text/javascript" src="modevlib/Dimension-Bugzilla.js"></script>
	<script type="text/javascript" src="modevlib/Dimension-Tracked.js"></script>
	<script type="text/javascript" src="modevlib/gui/ProductFilter.js"></script>
	<script type="text/javascript" src="modevlib/gui/GUI.js"></script>
	<script type="text/javascript" src="modevlib/Hierarchy.js"></script>
	<link rel="icon" href="images/fxos.ico" type="image/x-icon"/>
	<script type="text/javascript" src="js/heat.js"></script>
	<link type="text/css" rel="stylesheet" href="css/menu.css">
	<script type="text/javascript" src="js/main_lib.js"></script>
	<style id="vakata-stylesheet" type="text/css"></style>
	<style id="jstree-stylesheet" type="text/css"></style>
	<link rel="stylesheet" type="text/css" media="all" href="lib/jstree/themes/default/style.css">

	<script>
    (function(i, s, o, g, r, a, m){
      i['GoogleAnalyticsObject'] = r;
      i[r] = i[r] || function(){
          (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
      a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
      a.async = 1;
      a.src = g;
      m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-49796218-5', 'mozilla.org');
    ga('send', 'pageview');
	</script>
</HEAD>
<BODY>
<div style="overflow:hidden;">
	<div class="content" style="position:inherit;">
		<center>
			<select id='version'>
				<option value='54'>Firefox 54</option>
				<option value='55'>Firefox 55</option>
				<option value='56'>Firefox 56</option>
				<option value='57'>Firefox 57</option>
			</select>
			<button id='load' class='load'>Load</button>
			<button id='burndown' class='burndown'>Burndown</button>
		</center>
		<div id="totals", style="width:100%;text-align:center;"><h1>Firefox Tracked Bugs</h1></div>
		<div id="blockers" style="text-align: center;"></div>
	</div>
	<div id="description" style="width:100%;text-align: center;font-size: 150%">
		<span style="font-weight: bold;font-size: 120%">Legend:</span>&nbsp;
		<span id="day0" style="display:inline-block;height:10px;width:10px;background-color:#008E00;"></span> New&nbsp;&nbsp;
		<span id="day1" style="display:inline-block;height:10px;width:10px;background-color:#318000;"></span> 1 day old&nbsp;&nbsp;
		<span id="day2" style="display:inline-block;height:10px;width:10px;background-color:#638700;"></span> 2 days old&nbsp;&nbsp;
		<span id="day3" style="display:inline-block;height:10px;width:10px;background-color:#857B00;"></span> 3 days old&nbsp;&nbsp;
		<span id="day4" style="display:inline-block;height:10px;width:10px;background-color:#A05700;"></span> 4 days old&nbsp;&nbsp;
		<span id="day5" style="display:inline-block;height:10px;width:10px;background-color:#8B3C00;"></span> 5 days old&nbsp;&nbsp;
		<span id="day6" style="display:inline-block;height:10px;width:10px;background-color:#8A1C00;"></span> 6 days old&nbsp;&nbsp;
		<span id="day7" style="display:inline-block;height:10px;width:10px;background-color:#980303;"></span> 7+ days old&nbsp;&nbsp;

		<span style="display:inline-block;bottom:0;width: 0;height: 0; border-style: solid; border-width: 0 0 10px 10px; border-color: transparent transparent #000000 transparent;"></span>
		Nobody Assigned
	</div>

	<div class="footer">
		Source at <a href="https://github.com/ashughes1/pi-tracked-bugs">https://github.com/ashughes1/pi-tracked-bugs</a>
	</div>
</div>

<script type="application/javascript">
	assignEventListeners();
	function assignEventListeners() {
        $('button.load').on('click', function(event) {
            var v = document.getElementById('version').selectedOptions[0].value;
			var url = location.href.split('tracked.html?')[0] + "tracked.html?version=" + v;
			location.assign(url);
		});
		$('button.burndown').on('click', function(event) {
            var v = document.getElementById('version').selectedOptions[0].value;
			var url = 'https://ashughes1.github.io/pi-tracked-bugs-burndown/burndown.html?cf_tracking_firefox' + v + '=%2B&Since=2017-01-01';
			window.open(url);
		});
	}

importScript('js/main_lib.js', function(){
  var version = location.search.split('version=')[1];
  
  var thread;

  function createChart(){
    if (thread !== undefined)
      thread.kill(true);
    thread = Thread.run(__createChart());
  }

  refresher(createChart);

  let __createChart = function*(){
    yield (ESQuery.loadColumns({"from": "bugs"}));


    a = Log.action("Get Bug Details", true);
    let allDetails = null;
    try {
      //PULL THE RAW DATA, AND THEN OPERATE ON IT 112K, 2.17sec time
      //THE AGGREGATES ARE SPENDING ABOUT 2/3 THE TIME TRANSMITTING THE QUERY
      allDetails = yield(ESQuery.run({
        "from": "bugs",
        "select": [
          "bug_id",
          "modified_ts",
          "keywords",
          "assigned_to",
          "component",
          "product",
		  "cf_tracking_firefox" + version,
          //"status_whiteboard"
        ],
        "esfilter": {
          "and": [
            Mozilla.Tracked["Tracked" + version].esfilter,
            Mozilla.BugStatus.Open.esfilter,
            Mozilla.CurrentRecords.esfilter,
            GUI.getFilters("bugs")
          ]
        }
      }));
    } finally {
      Log.actionDone(a);
    }//try


    // DEFINE status_whiteboard.tokenized
    //String.property_tokenized = function(){};
    //allDetails.list.forall(function(d){
    //  let preTokens = d.status_whiteboard.split("[");
    //  let tokens = preTokens.mapExists(function(t){
    //    if (t.trim() == "") return;
    //    return t.split("]")[0].trim();
    //  });
    //  String.property_tokenized[d.status_whiteboard] = tokens;
    //});
    if (!"".tokenized) {
      Object.defineProperty(String.prototype, 'tokenized', {
        get: function(){
          let output =String.property_tokenized[this];
          return output ? output : [];
        }
      });
    }//endif


    let components = yield(Qb.calc2List({
      "from": allDetails,
      "select": [
        {"name": "show", "value": 'bug_id', "aggregate": "exists"},
        {"name": "count", "value": "bug_id", "aggregate": "count"},
        {"name": "bugs", "value": "bug_id", "aggregate": "array"},
        {"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "median"},
        {"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"},
        {"name": "unassignedBugs", "value": '(assigned_to=="nobody@mozilla.org" ? bug_id : null)', "aggregate": "array"}
      ],
      "edges": [
        {"name": "team", "domain": Mozilla.Tracked.Team.getDomain()}
      ]
    }));

    components.list = Qb.sort(components.list, "team.ordering");

    $("#blockers").html("");
    components.list.forall(function(team, i){
      let blockerHTML = showTeam(team, showBlocker);
      $("#blockers").append(blockerHTML);
    });

    let projectDomain = Mozilla.Tracked.Project.getDomain();
    projectDomain.name = "project";
    projectDomain.end = function(p){
      return p.name;
    };
    let totals = yield(Q({
      "from": allDetails,
      "select": [
        {"name": "show", "value": "bug_id", "aggregate": "exists"},
        {"name": "additionalClass", "value": '"project-summary"', "aggregate": "one"},
        {"name": "count", "value": "bug_id", "aggregate": "count"},
        {"name": "bugs", "value": "bug_id", "aggregate": "array"},
        {"name": "age", "value": "Date.now().subtract(Date.newInstance(modified_ts)).divideBy(Duration.DAY)", "aggregate": "median"},
        {"name": "unassignedCount", "value": '(assigned_to=="nobody@mozilla.org" ? 1 : 0)', "aggregate": "sum"},
        {"name": "unassignedBugs", "value": '(assigned_to=="nobody@mozilla.org" ? bug_id : null)', "aggregate": "array"}
      ],
      "edges": [
        {"name": "project", "domain": projectDomain}
      ]
    }));


    let grandTotal = {
      "project": "Total",
      "count": aMath.SUM(totals.cube.select("count")),
      "unassignedCount": aMath.SUM(totals.cube.select("unassignedCount")),
      "age": aMath.MAX(totals.cube.select("age")),
      "bugs": totals.from.list.select("bug_id"),
      "unassignedBugs": totals.from.list.filter(Mozilla.Tracked["Tracked" + version + "_unassigned"].esfilter).select("bug_id"),
      "additionalClass": "project-summary"
    };

    var blockerHTML = showSummary("Firefox " + version + " Tracked Bugs", GUI.state.team.getSelectedParts(), totals, grandTotal, null, showTotal);
	
    $("#totals").html(blockerHTML);

    addProjectClickers(components);
    showLastUpdated();
  };

  $(document).ready(function(){
    GUI.setup(
      createChart,
      [
        {
          "id": "team", "name": "Teams", "type": PartitionFilter.newInstance({
          "id": "Teams",
          "name": "All Teams",
          "dimension": Mozilla.Tracked.Team,
          "onlyOne": false,
          "expandAll": true
        })
        },
        {
          "id": "component", "name": "Components", "type": PartitionFilter.newInstance({
          "id": "Components",
          "name": "All Components",
          "dimension": Mozilla.Tracked.Component,
          "onlyOne": false,
          "expandAll": true
        })
        }

      ],
      [],
      null,
      false		//SHOW DEFAULT FILTERS?
    );
  });
});
</script>


</BODY>
</HTML>




